function applyCase(t,e){if(!t)return"";switch(e){case"uc":return t.toUpperCase();case"lc":return t.toLowerCase();case"ic":return t.charAt(0).toUpperCase()+t.slice(1).toLowerCase();case"sp":return t.split("").map(((t,e)=>e%2==0?t.toUpperCase():t.toLowerCase())).join("");default:return t}}class WFont{constructor(t,e,n=null){this.name=t,this.url=e,this.style=n,this.fullFontName=e?t:`${t} ${n}`.trim(),this.loading=!1,this.loaded=!1,this.error=!1,this.computed=null,this.load()}async load(){try{if(this.loaded=!1,this.loading=!0,this.url){const t=new FontFace(this.name,`url(${this.url})`);await t.load(),document.fonts.add(t)}else await this.checkLocalFont();this.loaded=!0,waterfall.computeIfReady()}catch(t){this.error=t,console.error("Error loading font:",t)}finally{this.loading=!1}}async checkLocalFont(){const t=document.createElement("canvas").getContext("2d");t.font=`12px "${this.fullFontName}"`,await document.fonts.load(t.font);if(t.measureText("abcdefghijklmnopqrstuvwxyz0123456789").width<=0)throw new Error(`Font "${this.fullFontName}" not available`)}compute(t,e,n){const o={},s=document.createElement("canvas").getContext("2d");s.font=`${waterfall.fontSize}px "${this.fullFontName}"`;for(const i of t){if(!i)continue;let t=applyCase(i,e);if(!t)continue;let a=s.measureText(t).width,l=Math.ceil(a/n)*n;l in o||(o[l]=[]),o[l].includes(t)||o[l].push(t)}this.computed=o,waterfall.updateUI()}}class Waterfall{constructor(){this.done=!1,this.fontSize=60,this.lineHeight=1,this.casing="ic",this.granularity=5,this.resultsCount=10,this._runlength=500,this.seed=1,this.shiftMode=!1,this.targetWord="",this.dict={loading:!1,loaded:!1,error:!1,manual:!1,dict:null},this.fonts=[],this.init(),this.fontInput=new FontInput(this),this.currentResultsCount=0,this.currentFont=null}init(){this.loadDict(),this.setupEventListeners()}setupEventListeners(){document.addEventListener("keydown",(t=>{t.isComposing||229===t.keyCode||16===t.keyCode&&(this.shiftMode=!0)})),document.addEventListener("keyup",(t=>{16===t.keyCode&&(this.shiftMode=!1)}));const t=document.getElementById("runlength");t&&t.addEventListener("input",(t=>{this.runlength=parseInt(t.target.value),this.updateUI()}));const e=document.getElementById("casing");e&&e.addEventListener("change",(t=>{this.casing=t.target.value,this.computeIfReady()}));const n=document.getElementById("targetWord");n&&n.addEventListener("input",(t=>{const e=t.target.value.trim();this.updateRunlengthFromWord(e)}));const o=document.getElementById("fontUploader");o&&o.addEventListener("change",(t=>{this.loadFonts(t.target.files)}));const s=document.getElementById("dictUploader");s&&s.addEventListener("change",(t=>{this.loadDict(t.target.files[0])}));const i=document.getElementById("resultsCountDisplay");i&&(i.textContent=this.resultsCount,this.updateUI())}async loadDict(t){try{let e;if(this.dict.dict=null,this.dict.loaded=!1,this.dict.error=!1,this.dict.loading=!0,t){if(this.dict.manual=!0,!t.name.endsWith(".txt"))throw new Error("Dictionary file must be .txt. (Reverting to default.)");e=await t.text()}else{this.dict.manual=!1;const t=await fetch("/words.txt");if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);e=await t.text()}this.dict.dict=e.split(/\r?\n/),this.dict.loaded=!0,this.computeIfReady()}catch(t){console.error("Error loading dictionary:",t),this.dict.error=t.message}finally{this.dict.loading=!1}}removeFont(t){this.fonts=this.fonts.filter((e=>e.file.name!==t))}async loadFonts(t){for(let e=0;e<t.length;e++){const n=new WFont(t[e]);this.fonts.push(n)}}refresh(){this.seed++,this.computeIfReady(),this.updateUI()}computeIfReady(){this.fonts.every((t=>t.loaded))&&this.dict.loaded&&this.compute()}compute(){console.log("computing");for(const t of this.fonts)t.compute(this.dict.dict,this.casing,this.granularity);this.done=!0,this.updateUI()}updateLengthFromWord(){if(this.targetWord&&this.fonts.length>0){const t=document.createElement("canvas").getContext("2d");t.font=`${this.fontSize}px ${this.fonts[0].reference}`;const e=t.measureText(this.targetWord).width;this.runlength=Math.round(e),this.refresh()}}updateRunlengthFromWord(t){if(!this.currentFont||!t)return;const e=document.createElement("canvas").getContext("2d");e.font=`${this.fontSize}px "${this.currentFont.fullFontName}"`;const n=e.measureText(t).width,o=Math.ceil(n);this.runlength=o}updateUI(){const t=document.getElementById("runlength"),e=document.getElementById("runlengthDisplay"),n=document.getElementById("resultsCountDisplay"),o=document.getElementById("results");if(t&&(t.value=this.runlength),e&&(e.textContent=this.runlength),o){o.innerHTML="",this.currentResultsCount=0;for(const t of this.fonts)if(t.computed){this.currentFont=t;const e=t.computed[this.quantizedRunlength]||[];this.currentResultsCount=e.length;const n=document.createElement("div");n.style.fontFamily=`"${t.fullFontName}"`,n.style.fontSize=`${this.fontSize}px`,n.style.lineHeight=this.lineHeight,e.length>0?n.innerHTML=e.join("<br>"):(n.innerHTML=this.getPlaceholderText(t.fullFontName),n.style.color="#888",n.style.fontStyle="italic"),o.appendChild(n)}}n&&(n.textContent=this.currentResultsCount)}get quantizedRunlength(){return Math.ceil(this._runlength/this.granularity)*this.granularity}get shiftStep(){return this.shiftMode?10:1}addFont(t,e){const n=new WFont(t,e);this.fonts.push(n),this.computeIfReady()}addLocalFont(t,e){const n=new WFont(t,null,e);this.fonts=[n],this.computeIfReady()}getFontWeight(t){return t&&t.toLowerCase().includes("bold")?"bold":"normal"}get runlength(){return this._runlength}set runlength(t){this._runlength=t,this.updateUI()}getPlaceholderText(t){return"..."}}class FontInput{constructor(t){this.waterfall=t,this.fontUpload=document.getElementById("fontUpload"),this.loadLocalFontsButton=document.getElementById("loadLocalFonts"),this.fontSelectors=document.getElementById("fontSelectors"),this.fontFamilySelector=document.getElementById("fontFamilySelector"),this.fontStyleSelector=document.getElementById("fontStyleSelector"),this.tabs=document.querySelectorAll(".font-input__tab"),this.contents=document.querySelectorAll(".font-input__content"),this.initTabs(),this.initFontUpload(),this.initLoadLocalFontsButton()}initTabs(){this.tabs.forEach((t=>{t.addEventListener("click",(()=>{this.tabs.forEach((t=>t.classList.remove("active"))),this.contents.forEach((t=>t.classList.remove("active"))),t.classList.add("active"),document.getElementById(`${t.dataset.tab}Content`).classList.add("active")}))}))}initFontUpload(){this.fontUpload.addEventListener("change",(t=>{const e=t.target.files[0];if(e){const t=new FileReader;t.onload=t=>{const n=e.name.split(".")[0],o=t.target.result;this.waterfall.addFont(n,o)},t.readAsDataURL(e)}}))}initLoadLocalFontsButton(){"queryLocalFonts"in window?this.loadLocalFontsButton.addEventListener("click",(()=>this.loadLocalFonts())):(this.loadLocalFontsButton.textContent="Font Access API not supported",this.loadLocalFontsButton.disabled=!0)}async loadLocalFonts(){try{const t=await window.queryLocalFonts(),e=new Set;t.forEach((t=>{e.add(t.family)})),this.populateFontFamilySelector(Array.from(e).sort(),t),this.fontFamilySelector.addEventListener("change",(()=>this.updateFontStyleSelector(t))),this.fontStyleSelector.addEventListener("change",(()=>this.updateWaterfallFont())),this.loadLocalFontsButton.style.display="none",this.fontSelectors.style.display="block"}catch(t){console.error("Error querying local fonts:",t),this.loadLocalFontsButton.textContent="Error loading fonts"}}populateFontFamilySelector(t,e){this.fontFamilySelector.innerHTML=t.map((t=>`<option value="${t}">${t}</option>`)).join(""),this.updateFontStyleSelector(e)}updateFontStyleSelector(t){const e=this.fontFamilySelector.value,n=t.filter((t=>t.family===e)).map((t=>t.style));this.fontStyleSelector.innerHTML=n.map((t=>`<option value="${t}">${t}</option>`)).join(""),this.updateWaterfallFont()}updateWaterfallFont(){const t=this.fontFamilySelector.value,e=this.fontStyleSelector.value;this.waterfall.addLocalFont(t,e)}}const waterfall=new Waterfall;